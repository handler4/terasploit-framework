#######
# Module: Exploit
#######

from __future__ import annotations
from libs.terasploit.framework.module.dependencies import *
from libs.terasploit.framework.info.info_container import module_info
from init.tsf.core.wildcard import Get


class Container(object):
    """ Container Descriptor Class """
    
    def __init__(self, value):
        self.value = value
    
    def __get__(self, instance, owner):
        return self.value
    
    
class Insert(Container):
    """ Insert Descriptor Class """
    
    def __set__(self, instance, value):
        self.value = value


class Target:
    """ Target Data """
    
    scheme = Insert(None)
    hostname = Insert(None)
    path = Insert(None)
    params = Insert(None)
    query = Insert(None)
    fragment = Insert(None)
    username = Insert(None)
    password = Insert(None)
    port = Insert(None)
    


class Exploit(object):
    """ Exploit Class """
    
    def ParseURL(self, vals) -> list:
        """ URL Target Parser """

        url = urlparse(vals)
        
        value = [url.scheme,url.hostname,url.path,url.params,url.query,url.fragment,url.username,url.password,url.port]
        key = ['scheme','hostname','path','params','query','fragment','username','password','port']
        for key, value in zip(key,value):
            if key == 'hostname':
                if url.hostname:
                    if url.port:
                        setattr(Target,key,f'{value}:{url.port}')
                        continue
                    setattr(Target,key,value)
                if not url.hostname:
                    setattr(Target,'hostname',vals)
            else:        
                setattr(Target,key,value)
    
    
    def GetProxy(self, path: str):
        """ Returns proxy contents from json """
        
        if path:
            with open(path,'r') as prox:
                proxies = json.load(prox)
            info_print (f"Proxies: {proxies}")
        else:
            proxies = {}
        
        return proxies
    
    
    def GetBoolean(self, value: str):
        """ Returns boolean value """
        
        if value:
            return True if value.lower() == 'true' else False
        else:
            return True
    
    
    def EncodeShell(self, content) -> any|None:
        """ Encodes payload base on what encoding the encoder uses """
        
        encoder, _ = Get.encoder()
        if encoder:
            encode_payload, boolean = encoder.encode(content,module_info.payload_info['Arch'])
            if boolean:
                return encode_payload
            else:
                return content
        if not encoder:
            return content
        
        
    def OPT(self):
        """ Returns the value of an option """
        
        opt_content = [x for x in Opt('exploit').Get()[0]]
        out = [Opt('exploit').GetOPT(x) for x in opt_content]

        return out

        
    def generate_random_name(self) -> str:
        """ Random Name Generator
        
        Generates a random int and str character and put it together to 
        create a random name for files and others.
        """

        return ''.join(random.choice(string.ascii_letters + string.digits) for i in range(10))


    def good_status_code(self) -> list[int]:
        """ Good Status Codes
        
        Returns a good status code, most likely for requests post or get.
        """
        
        return [200,201]
    
    
    def disable_insecure_request_warning(self) -> None:
        """ Insecure request warning
        
        Disables warning from urllib3 that indicates 
        insecure http request.
        """
        
        return urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)
    
    
    def pool_manager_cert_required(self,cert_Reqs) -> urllib3.PoolManager:
        """ cert required pool manager - urllib3 """
        
        return urllib3.PoolManager(cert_reqs=cert_Reqs)